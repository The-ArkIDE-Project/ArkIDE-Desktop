name: Build Flatpak

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., v1.0.0)'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Install flatpak and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder

      - name: Add flathub remote
        run: |
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

      - name: Install runtimes and SDK
        run: |
          sudo flatpak install -y flathub org.freedesktop.Platform/x86_64/23.08
          sudo flatpak install -y flathub org.freedesktop.Sdk/x86_64/23.08

      - name: Download release artifact
        run: |
          mkdir -p build-input
          wget -O build-input/build.tar.gz "https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.version }}/ArkIDE-Desktop-build.tar.gz"
          cd build-input && tar -xzf build.tar.gz && cd ..

      - name: Build Flatpak
        run: |
          sudo flatpak-builder --force-clean --repo=repo build-dir .flatpak/com.arkide.desktop.json

      - name: Create bundle
        run: |
          sudo flatpak build-bundle repo com.arkide.desktop.flatpak com.arkide.desktop
          sudo chown $USER com.arkide.desktop.flatpak

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: com.arkide.desktop.flatpak
          tag_name: ${{ github.event.inputs.version }}-flatpak
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
